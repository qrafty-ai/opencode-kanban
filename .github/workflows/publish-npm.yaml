name: Publish npm

on:
  workflow_run:
    workflows: ["Release"]
    types: [completed]

permissions:
  contents: read

concurrency:
  group: publish-npm-${{ github.event.workflow_run.head_branch || github.run_id }}
  cancel-in-progress: true

jobs:
  package-tarballs:
    name: Package npm tarballs
    if: ${{ github.event.workflow_run.conclusion == 'success' && startsWith(github.event.workflow_run.head_branch, 'v') }}
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Resolve release metadata
        id: release
        shell: bash
        run: |
          set -euo pipefail
          tag="${{ github.event.workflow_run.head_branch }}"
          if [[ ! "${tag}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-alpha\.[0-9]+)?$ ]]; then
            echo "Unsupported release tag: ${tag}"
            exit 1
          fi
          echo "tag=${tag}" >> "$GITHUB_OUTPUT"
          echo "version=${tag#v}" >> "$GITHUB_OUTPUT"
          echo "run_id=${{ github.event.workflow_run.id }}" >> "$GITHUB_OUTPUT"

      - name: Download release workflow artifacts
        shell: bash
        run: |
          set -euo pipefail
          gh run download "${{ steps.release.outputs.run_id }}" --pattern "artifacts-build-local-*" --dir dist/release-artifacts

      - name: Stage vendor payloads from dist artifacts
        shell: bash
        run: |
          set -euo pipefail

          declare -A archives
          archives["x86_64-unknown-linux-gnu"]="dist/release-artifacts/artifacts-build-local-x86_64-unknown-linux-gnu/opencode-kanban-x86_64-unknown-linux-gnu.tar.xz"
          archives["aarch64-unknown-linux-gnu"]="dist/release-artifacts/artifacts-build-local-aarch64-unknown-linux-gnu/opencode-kanban-aarch64-unknown-linux-gnu.tar.xz"
          archives["x86_64-apple-darwin"]="dist/release-artifacts/artifacts-build-local-x86_64-apple-darwin/opencode-kanban-x86_64-apple-darwin.tar.xz"
          archives["aarch64-apple-darwin"]="dist/release-artifacts/artifacts-build-local-aarch64-apple-darwin/opencode-kanban-aarch64-apple-darwin.tar.xz"

          for target in "${!archives[@]}"; do
            archive="${archives[$target]}"
            if [[ ! -f "${archive}" ]]; then
              echo "Missing dist artifact for ${target}: ${archive}"
              exit 1
            fi

            unpack_dir="$(mktemp -d)"
            tar -xJf "${archive}" -C "${unpack_dir}"

            archive_base="$(basename "${archive}" .tar.xz)"
            source_path="${unpack_dir}/${archive_base}/opencode-kanban"
            if [[ ! -f "${source_path}" ]]; then
              echo "Binary not found in archive for ${target}: ${source_path}"
              exit 1
            fi

            destination_dir="vendor/${target}/opencode-kanban"
            mkdir -p "${destination_dir}"
            cp "${source_path}" "${destination_dir}/opencode-kanban"
            chmod +x "${destination_dir}/opencode-kanban"
            rm -rf "${unpack_dir}"
          done

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 22

      - name: Build npm packages
        shell: bash
        run: |
          set -euo pipefail
          python3 npm/scripts/build_npm_package.py \
            --version "${{ steps.release.outputs.version }}" \
            --vendor-src vendor \
            --out-dir dist/npm

      - name: Upload npm tarballs
        uses: actions/upload-artifact@v4
        with:
          name: npm-tarballs
          path: dist/npm/*.tgz
          if-no-files-found: error

  publish:
    name: Publish to npm
    if: ${{ github.event.workflow_run.conclusion == 'success' && startsWith(github.event.workflow_run.head_branch, 'v') }}
    needs: package-tarballs
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 22
          registry-url: https://registry.npmjs.org
          scope: "@qrafty-ai"

      - name: Update npm
        run: npm install -g npm@latest

      - name: Download npm tarballs
        uses: actions/download-artifact@v7
        with:
          name: npm-tarballs
          path: dist/npm

      - name: Resolve npm dist-tag
        id: npm_tag
        shell: bash
        run: |
          set -euo pipefail
          version="${{ github.event.workflow_run.head_branch }}"
          version="${version#v}"
          if [[ "${version}" =~ -alpha\.[0-9]+$ ]]; then
            echo "npm_tag=alpha" >> "$GITHUB_OUTPUT"
          else
            echo "npm_tag=" >> "$GITHUB_OUTPUT"
          fi

      - name: Publish tarballs
        env:
          VERSION: ${{ github.event.workflow_run.head_branch }}
          NPM_TAG: ${{ steps.npm_tag.outputs.npm_tag }}
        shell: bash
        run: |
          set -euo pipefail

          VERSION="${VERSION#v}"

          prefix=""
          if [[ -n "${NPM_TAG}" ]]; then
            prefix="${NPM_TAG}-"
          fi

          shopt -s nullglob
          tarballs=(dist/npm/*.tgz)
          if [[ ${#tarballs[@]} -eq 0 ]]; then
            echo "No npm tarballs found"
            exit 1
          fi

          for tarball in "${tarballs[@]}"; do
            filename="$(basename "${tarball}")"
            publish_tag=""

            case "${filename}" in
              qrafty-ai-opencode-kanban-npm-"${VERSION}".tgz)
                publish_tag="${NPM_TAG}"
                ;;
              qrafty-ai-opencode-kanban-npm-*-"${VERSION}".tgz)
                platform="${filename#qrafty-ai-opencode-kanban-npm-}"
                platform="${platform%-${VERSION}.tgz}"
                publish_tag="${prefix}${platform}"
                ;;
              *)
                echo "Unexpected tarball name: ${filename}"
                exit 1
                ;;
            esac

            publish_cmd=(npm publish "${tarball}" --access public --provenance)
            if [[ -n "${publish_tag}" ]]; then
              publish_cmd+=(--tag "${publish_tag}")
            fi

            echo "+ ${publish_cmd[*]}"
            set +e
            publish_output="$("${publish_cmd[@]}" 2>&1)"
            publish_status=$?
            set -e

            echo "${publish_output}"
            if [[ ${publish_status} -eq 0 ]]; then
              continue
            fi

            if grep -qiE "previously published|cannot publish over|version already exists" <<< "${publish_output}"; then
              echo "Skipping already-published package version for ${filename}"
              continue
            fi

            exit "${publish_status}"
          done
